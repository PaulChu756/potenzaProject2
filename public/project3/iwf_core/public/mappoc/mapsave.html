<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <style type="text/css">
      html { height: 100% }
      body { height: 100%; margin: 0; padding: 0 }
      #map-canvas { height: 100% }
    </style>
    <script type="text/javascript"
      src="https://maps.googleapis.com/maps/api/js?libraries=drawing&key=AIzaSyBO0QnQyN0yGuTRGryCs40T3HRpep-j8tg&sensor=true">
    </script>
    <script src="/js/json2.js"></script>
    <script type="text/javascript">
    var mapOverlays = new Array();

    function mapToObject(mapObj){
        var tmpMap = new Object;
        var tmpOverlay, paths;
        tmpMap.zoom = mapObj.getZoom();
        tmpMap.tilt = mapObj.getTilt();
        tmpMap.mapTypeId = mapObj.getMapTypeId();
        tmpMap.center = { lat: mapObj.getCenter().lat(), lng: mapObj.getCenter().lng() };
        tmpMap.overlays = new Array();

        for( var i=0; i < mapOverlays.length; i++ ){
            if( mapOverlays[i].getMap() == null ){
                continue;
            }
            tmpOverlay = new Object;
            tmpOverlay.type = mapOverlays[i].type;
            tmpOverlay.title = mapOverlays[i].title;
            tmpOverlay.content = mapOverlays[i].content;

            if( mapOverlays[i].fillColor ){
                tmpOverlay.fillColor = mapOverlays[i].fillColor;
            }

            if( mapOverlays[i].fillOpacity ){
                tmpOverlay.fillOpacity = mapOverlays[i].fillOpacity;
            }

            if( mapOverlays[i].strokeColor ){
                tmpOverlay.strokeColor = mapOverlays[i].strokeColor;
            }

            if( mapOverlays[i].strokeOpacity ){
                tmpOverlay.strokeOpacity = mapOverlays[i].strokeOpacity;
            }

            if( mapOverlays[i].strokeWeight ){
                tmpOverlay.strokeWeight = mapOverlays[i].strokeWeight;
            }

            if( mapOverlays[i].icon ){
                tmpOverlay.icon = mapOverlays[i].icon;
            }

            if( mapOverlays[i].flat ){
                tmpOverlay.flat = mapOverlays[i].flat;
            }

            if( mapOverlays[i].type == "polygon" ){
                tmpOverlay.paths = new Array();
                paths = mapOverlays[i].getPaths();
                for( var j=0; j < paths.length; j++ ){
                    tmpOverlay.paths[j] = new Array();
                    for( var k=0; k < paths.getAt(j).length; k++ ){
                        tmpOverlay.paths[j][k] = { lat: paths.getAt(j).getAt(k).lat().toString() , lng: paths.getAt(j).getAt(k).lng().toString() };
                    }
                }

            }else if( mapOverlays[i].type == "polyline" ){
                tmpOverlay.path = new Array();
                path = mapOverlays[i].getPath();
                for( var j=0; j < path.length; j++ ){
                    tmpOverlay.path[j] = { lat: path.getAt(j).lat().toString() , lng: path.getAt(j).lng().toString() };
                }

            }else if( mapOverlays[i].type == "circle" ){
                tmpOverlay.center = { lat: mapOverlays[i].getCenter().lat(), lng: mapOverlays[i].getCenter().lng() };
                tmpOverlay.radius = mapOverlays[i].radius;
            }else if( mapOverlays[i].type == "rectangle" ){
                tmpOverlay.bounds = {  sw: {lat: mapOverlays[i].getBounds().getSouthWest().lat(), lng: mapOverlays[i].getBounds().getSouthWest().lng()},
                    ne:     {lat: mapOverlays[i].getBounds().getNorthEast().lat(), lng: mapOverlays[i].getBounds().getNorthEast().lng()}
                };
            }else if( mapOverlays[i].type == "marker" ){
                tmpOverlay.position = { lat: mapOverlays[i].getPosition().lat(), lng: mapOverlays[i].getPosition().lng() };
            }
            tmpMap.overlays.push( tmpOverlay );
        }

        console.log(tmpMap);
        return tmpMap;

    }

      function initialize() {
        var mapOptions = {
          center: new google.maps.LatLng(30.114901, -91.995957),
          zoom: 22
        };
        var map = new google.maps.Map(document.getElementById("map-canvas"),
            mapOptions);
        var drawingManager = new google.maps.drawing.DrawingManager({
          drawingMode: google.maps.drawing.OverlayType.MARKER,
          drawingControl: true,
          drawingControlOptions: {
            position: google.maps.ControlPosition.TOP_CENTER,
            drawingModes: [
              google.maps.drawing.OverlayType.MARKER,
              google.maps.drawing.OverlayType.CIRCLE,
              google.maps.drawing.OverlayType.POLYGON,
              google.maps.drawing.OverlayType.POLYLINE,
              google.maps.drawing.OverlayType.RECTANGLE
            ]
          },
          markerOptions: {
            icon: 'http://www.example.com/icon.png'
          },
          circleOptions: {
            fillColor: '#ffff00',
            fillOpacity: 1,
            strokeWeight: 5,
            clickable: false,
            zIndex: 1,
            editable: true
          }
        }); 
        drawingManager.setMap(map);
        google.maps.event.addListener(drawingManager, 'overlaycomplete', function(event) {
            var uniqueid =  uniqid();
            event.overlay.uniqueid =  uniqueid;
            event.overlay.title = "";
            event.overlay.content = "";
            event.overlay.type = event.type;
            mapOverlays.push(event.overlay);
            mapToObject(map);
            var result = JSON.stringify( mapToObject(map) );
            document.getElementById('map-json').value = result;
            //console.log(event);
        });
      }

      google.maps.event.addDomListener(window, 'load', initialize);

      /* Helper functions */

    function uniqid(){
        var newDate = new Date;
        return newDate.getTime();
    }

    </script>
    <style>
        #map-canvas {
            width: 800px;
            height: 800px;
        }
    </style>
  </head>
  <body>
    <h1>Select Region</h1>
    <textarea id="map-json"></textarea>
    <div id="map-canvas"/>
  </body>
</html>